# SCORPIUS Security Platform - Enterprise API Gateway Configuration
# Kong API Gateway Configuration for Production Deployment

apiVersion: v1
kind: ConfigMap
metadata:
  name: scorpius-api-gateway-config
  namespace: scorpius-production
data:
  kong.yaml: |
    _format_version: "3.0"
    _transform: true

    # ==========================================
    # SERVICES CONFIGURATION
    # ==========================================

    services:
      # Core Authentication Service
      - name: auth-service
        url: http://auth-service:3001
        protocol: http
        host: auth-service
        port: 3001
        path: /
        connect_timeout: 10000
        write_timeout: 60000
        read_timeout: 60000
        retries: 3
        tags:
          - core
          - authentication

      # Security Scanner Service
      - name: scanner-service
        url: http://scanner-service:3002
        protocol: http
        host: scanner-service
        port: 3002
        path: /
        connect_timeout: 30000
        write_timeout: 300000
        read_timeout: 300000
        retries: 2
        tags:
          - security
          - analysis

      # Honeypot Detection Service
      - name: honeypot-service
        url: http://honeypot-service:3003
        protocol: http
        host: honeypot-service
        port: 3003
        path: /
        connect_timeout: 15000
        write_timeout: 120000
        read_timeout: 120000
        retries: 2
        tags:
          - security
          - detection

      # MEV Operations Service
      - name: mev-service
        url: http://mev-service:3004
        protocol: http
        host: mev-service
        port: 3004
        path: /
        connect_timeout: 5000
        write_timeout: 30000
        read_timeout: 30000
        retries: 3
        tags:
          - mev
          - trading

      # Wallet Guard Service
      - name: wallet-service
        url: http://wallet-service:3005
        protocol: http
        host: wallet-service
        port: 3005
        path: /
        connect_timeout: 10000
        write_timeout: 60000
        read_timeout: 60000
        retries: 2
        tags:
          - security
          - wallet

      # Time Machine Service
      - name: time-machine-service
        url: http://time-machine-service:3006
        protocol: http
        host: time-machine-service
        port: 3006
        path: /
        connect_timeout: 20000
        write_timeout: 180000
        read_timeout: 180000
        retries: 1
        tags:
          - analytics
          - historical

      # Analytics Service
      - name: analytics-service
        url: http://analytics-service:3007
        protocol: http
        host: analytics-service
        port: 3007
        path: /
        connect_timeout: 10000
        write_timeout: 60000
        read_timeout: 60000
        retries: 2
        tags:
          - analytics
          - metrics

      # User Management Service
      - name: user-service
        url: http://user-service:3008
        protocol: http
        host: user-service
        port: 3008
        path: /
        connect_timeout: 10000
        write_timeout: 60000
        read_timeout: 60000
        retries: 3
        tags:
          - core
          - users

      # Plugin Manager Service
      - name: plugin-service
        url: http://plugin-service:3009
        protocol: http
        host: plugin-service
        port: 3009
        path: /
        connect_timeout: 15000
        write_timeout: 120000
        read_timeout: 120000
        retries: 2
        tags:
          - plugins
          - extensions

      # System Management Service
      - name: system-service
        url: http://system-service:3010
        protocol: http
        host: system-service
        port: 3010
        path: /
        connect_timeout: 10000
        write_timeout: 60000
        read_timeout: 60000
        retries: 2
        tags:
          - system
          - monitoring

      # WebSocket Gateway Service
      - name: websocket-service
        url: http://websocket-service:3011
        protocol: http
        host: websocket-service
        port: 3011
        path: /
        connect_timeout: 5000
        write_timeout: 300000
        read_timeout: 300000
        retries: 3
        tags:
          - realtime
          - websocket

      # SDK Distribution Service
      - name: sdk-service
        url: http://sdk-service:3012
        protocol: http
        host: sdk-service
        port: 3012
        path: /
        connect_timeout: 10000
        write_timeout: 60000
        read_timeout: 60000
        retries: 2
        tags:
          - sdk
          - distribution

    # ==========================================
    # ROUTES CONFIGURATION
    # ==========================================

    routes:
      # Authentication Routes
      - name: auth-login
        service: auth-service
        paths:
          - /api/v1/auth/login
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: auth-logout
        service: auth-service
        paths:
          - /api/v1/auth/logout
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: auth-refresh
        service: auth-service
        paths:
          - /api/v1/auth/refresh
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: auth-2fa
        service: auth-service
        paths:
          - /api/v1/auth/verify-2fa
        methods:
          - POST
        strip_path: false
        preserve_host: false

      # Security Scanner Routes
      - name: scanner-analyze
        service: scanner-service
        paths:
          - /api/v1/scanner/analyze
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: scanner-results
        service: scanner-service
        paths:
          - /api/v1/scanner/results
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: scanner-slither
        service: scanner-service
        paths:
          - /api/v1/scanner/slither
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: scanner-mythril
        service: scanner-service
        paths:
          - /api/v1/scanner/mythril
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: scanner-manticore
        service: scanner-service
        paths:
          - /api/v1/scanner/manticore
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: scanner-engines-status
        service: scanner-service
        paths:
          - /api/v1/scanner/engines/status
        methods:
          - GET
        strip_path: false
        preserve_host: false

      # Honeypot Detection Routes
      - name: honeypot-analyze
        service: honeypot-service
        paths:
          - /api/v1/honeypot/analyze
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: honeypot-results
        service: honeypot-service
        paths:
          - /api/v1/honeypot/results
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: honeypot-simulation-replay
        service: honeypot-service
        paths:
          - /api/v1/honeypot/simulation/replay
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: honeypot-watchlist
        service: honeypot-service
        paths:
          - /api/v1/honeypot/watchlist
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: false
        preserve_host: false

      # MEV Operations Routes
      - name: mev-strategies
        service: mev-service
        paths:
          - /api/v1/mev/strategies
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: false
        preserve_host: false

      - name: mev-opportunities
        service: mev-service
        paths:
          - /api/v1/mev/opportunities
        methods:
          - GET
          - POST
        strip_path: false
        preserve_host: false

      # Wallet Guard Routes
      - name: wallet-analyze
        service: wallet-service
        paths:
          - /api/v1/wallet/analyze
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: wallet-risk-profile
        service: wallet-service
        paths:
          - /api/v1/wallet/risk-profile
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: wallet-approvals
        service: wallet-service
        paths:
          - /api/v1/wallet/approvals
        methods:
          - GET
          - POST
        strip_path: false
        preserve_host: false

      # Time Machine Routes
      - name: time-machine-query
        service: time-machine-service
        paths:
          - /api/v1/time-machine/query
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: time-machine-exploits
        service: time-machine-service
        paths:
          - /api/v1/time-machine/exploits
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: time-machine-replay
        service: time-machine-service
        paths:
          - /api/v1/time-machine/replay
        methods:
          - POST
        strip_path: false
        preserve_host: false

      # Analytics Routes
      - name: analytics-dashboard
        service: analytics-service
        paths:
          - /api/v1/analytics/dashboard
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: analytics-charts
        service: analytics-service
        paths:
          - /api/v1/analytics/charts
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: analytics-custom-query
        service: analytics-service
        paths:
          - /api/v1/analytics/custom-query
        methods:
          - POST
        strip_path: false
        preserve_host: false

      - name: analytics-reports
        service: analytics-service
        paths:
          - /api/v1/analytics/reports
        methods:
          - GET
          - POST
        strip_path: false
        preserve_host: false

      # User Management Routes
      - name: user-profile
        service: user-service
        paths:
          - /api/v1/user/profile
        methods:
          - GET
          - PUT
        strip_path: false
        preserve_host: false

      - name: user-settings
        service: user-service
        paths:
          - /api/v1/settings
        methods:
          - GET
          - PUT
          - POST
        strip_path: false
        preserve_host: false

      # Plugin System Routes
      - name: plugins-list
        service: plugin-service
        paths:
          - /api/v1/plugins
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: plugins-manage
        service: plugin-service
        paths:
          - /api/v1/plugins
        methods:
          - POST
          - PUT
          - DELETE
        strip_path: false
        preserve_host: false

      # System Management Routes
      - name: system-status
        service: system-service
        paths:
          - /api/v1/system/status
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: system-metrics
        service: system-service
        paths:
          - /api/v1/system/metrics
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: system-logs
        service: system-service
        paths:
          - /api/v1/system/logs
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: system-database
        service: system-service
        paths:
          - /api/v1/system/database
        methods:
          - GET
          - POST
        strip_path: false
        preserve_host: false

      # WebSocket Routes
      - name: websocket-realtime
        service: websocket-service
        paths:
          - /ws/realtime
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: websocket-mempool
        service: websocket-service
        paths:
          - /ws/mempool
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: websocket-scanner
        service: websocket-service
        paths:
          - /ws/scanner
        methods:
          - GET
        strip_path: false
        preserve_host: false

      # SDK Distribution Routes
      - name: sdk-javascript
        service: sdk-service
        paths:
          - /api/v1/sdk/js
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: sdk-python
        service: sdk-service
        paths:
          - /api/v1/sdk/python
        methods:
          - GET
        strip_path: false
        preserve_host: false

      - name: sdk-auth
        service: sdk-service
        paths:
          - /api/v1/sdk/auth
        methods:
          - POST
        strip_path: false
        preserve_host: false

    # ==========================================
    # PLUGINS CONFIGURATION
    # ==========================================

    plugins:
      # Global Rate Limiting
      - name: rate-limiting
        config:
          minute: 1000
          hour: 10000
          day: 100000
          policy: cluster
          hide_client_headers: false
          fault_tolerant: true

      # Global CORS
      - name: cors
        config:
          origins:
            - "https://app.scorpius.dev"
            - "https://dashboard.scorpius.dev"
            - "https://sdk.scorpius.dev"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
            - X-API-Key
            - X-Requested-With
          exposed_headers:
            - X-Auth-Token
            - X-RateLimit-Remaining
            - X-RateLimit-Limit
          credentials: true
          max_age: 3600

      # Global Request/Response Logging
      - name: file-log
        config:
          path: /var/log/kong/access.log
          reopen: true

      # Global Prometheus Metrics
      - name: prometheus
        config:
          per_consumer: true
          status_code_metrics: true
          latency_metrics: true
          bandwidth_metrics: true

      # Global Request Transformer
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Gateway-Version:2.1.0"
              - "X-Request-ID:$(uuid)"
            querystring: []
          remove:
            headers:
              - "X-Internal-Secret"

      # Global Response Transformer
      - name: response-transformer
        config:
          add:
            headers:
              - "X-Powered-By:SCORPIUS-API-Gateway"
              - "X-Response-Time:$(response_time)"

      # Security Headers
      - name: response-transformer
        config:
          add:
            headers:
              - "X-Content-Type-Options:nosniff"
              - "X-Frame-Options:DENY"
              - "X-XSS-Protection:1; mode=block"
              - "Strict-Transport-Security:max-age=31536000; includeSubDomains"
              - "Content-Security-Policy:default-src 'self'"

      # JWT Authentication (Applied to protected routes)
      - name: jwt
        route: scanner-analyze
        config:
          secret_is_base64: false
          claims_to_verify:
            - exp
            - iat
          key_claim_name: iss
          maximum_expiration: 86400

      # API Key Authentication (Applied to SDK routes)
      - name: key-auth
        route: sdk-javascript
        config:
          key_names:
            - X-API-Key
            - apikey
          hide_credentials: true

      # Rate Limiting per Consumer (Heavy operations)
      - name: rate-limiting
        route: scanner-analyze
        config:
          minute: 10
          hour: 100
          day: 1000
          policy: cluster

      - name: rate-limiting
        route: honeypot-analyze
        config:
          minute: 20
          hour: 200
          day: 2000
          policy: cluster

      - name: rate-limiting
        route: time-machine-replay
        config:
          minute: 5
          hour: 50
          day: 500
          policy: cluster

      # Request Size Limiting
      - name: request-size-limiting
        config:
          allowed_payload_size: 10

      # IP Restriction (for admin endpoints)
      - name: ip-restriction
        route: system-database
        config:
          allow:
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"
          deny: []

      # Circuit Breaker
      - name: proxy-cache
        config:
          response_code:
            - 200
            - 301
            - 404
          request_method:
            - GET
            - HEAD
          content_type:
            - "application/json"
          cache_ttl: 300
          strategy: memory

    # ==========================================
    # CONSUMERS CONFIGURATION
    # ==========================================

    consumers:
      - username: frontend-app
        custom_id: frontend-001
        tags:
          - frontend
          - production

      - username: mobile-app
        custom_id: mobile-001
        tags:
          - mobile
          - production

      - username: enterprise-client
        custom_id: enterprise-001
        tags:
          - enterprise
          - production

      - username: sdk-user
        custom_id: sdk-001
        tags:
          - sdk
          - integration

    # Consumer Credentials
    jwt_secrets:
      - consumer: frontend-app
        key: scorpius-frontend
        algorithm: HS256
        secret: ${FRONTEND_JWT_SECRET}

      - consumer: mobile-app
        key: scorpius-mobile
        algorithm: HS256
        secret: ${MOBILE_JWT_SECRET}

      - consumer: enterprise-client
        key: scorpius-enterprise
        algorithm: HS256
        secret: ${ENTERPRISE_JWT_SECRET}

    keyauth_credentials:
      - consumer: sdk-user
        key: ${SDK_API_KEY}

    # ==========================================
    # UPSTREAMS CONFIGURATION
    # ==========================================

    upstreams:
      - name: scanner-upstream
        algorithm: round-robin
        hash_on: none
        hash_fallback: none
        healthchecks:
          active:
            type: http
            http_path: /health
            healthy:
              interval: 10
              successes: 3
            unhealthy:
              interval: 10
              http_failures: 3
              timeouts: 3
          passive:
            type: http
            healthy:
              successes: 3
            unhealthy:
              http_failures: 3
              timeouts: 3

      - name: honeypot-upstream
        algorithm: round-robin
        hash_on: none
        hash_fallback: none
        healthchecks:
          active:
            type: http
            http_path: /health
            healthy:
              interval: 10
              successes: 3
            unhealthy:
              interval: 10
              http_failures: 3
              timeouts: 3

      - name: mev-upstream
        algorithm: least-connections
        hash_on: none
        hash_fallback: none
        healthchecks:
          active:
            type: http
            http_path: /health
            healthy:
              interval: 5
              successes: 2
            unhealthy:
              interval: 5
              http_failures: 2
              timeouts: 2

    # ==========================================
    # TARGETS CONFIGURATION
    # ==========================================

    targets:
      - target: scanner-service-1:3002
        upstream: scanner-upstream
        weight: 100

      - target: scanner-service-2:3002
        upstream: scanner-upstream
        weight: 100

      - target: honeypot-service-1:3003
        upstream: honeypot-upstream
        weight: 100

      - target: honeypot-service-2:3003
        upstream: honeypot-upstream
        weight: 100

      - target: mev-service-1:3004
        upstream: mev-upstream
        weight: 100

      - target: mev-service-2:3004
        upstream: mev-upstream
        weight: 100

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong-gateway
  namespace: scorpius-production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: kong-gateway
  template:
    metadata:
      labels:
        app: kong-gateway
    spec:
      containers:
        - name: kong
          image: kong:3.4-alpine
          ports:
            - containerPort: 8000
              name: proxy
            - containerPort: 8001
              name: admin
            - containerPort: 8443
              name: proxy-ssl
            - containerPort: 8444
              name: admin-ssl
          env:
            - name: KONG_DATABASE
              value: "postgres"
            - name: KONG_PG_HOST
              value: "postgres-service"
            - name: KONG_PG_PORT
              value: "5432"
            - name: KONG_PG_USER
              valueFrom:
                secretKeyRef:
                  name: kong-postgres-secret
                  key: username
            - name: KONG_PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: kong-postgres-secret
                  key: password
            - name: KONG_PROXY_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_ADMIN_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_PROXY_ERROR_LOG
              value: "/dev/stderr"
            - name: KONG_ADMIN_ERROR_LOG
              value: "/dev/stderr"
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001, 0.0.0.0:8444 ssl"
            - name: KONG_DECLARATIVE_CONFIG
              value: "/kong/kong.yaml"
          volumeMounts:
            - name: kong-config
              mountPath: /kong
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: kong-config
          configMap:
            name: scorpius-api-gateway-config

---
apiVersion: v1
kind: Service
metadata:
  name: kong-gateway-service
  namespace: scorpius-production
spec:
  type: LoadBalancer
  ports:
    - name: proxy
      port: 80
      targetPort: 8000
      protocol: TCP
    - name: proxy-ssl
      port: 443
      targetPort: 8443
      protocol: TCP
  selector:
    app: kong-gateway

---
apiVersion: v1
kind: Service
metadata:
  name: kong-admin-service
  namespace: scorpius-production
spec:
  type: ClusterIP
  ports:
    - name: admin
      port: 8001
      targetPort: 8001
      protocol: TCP
  selector:
    app: kong-gateway
